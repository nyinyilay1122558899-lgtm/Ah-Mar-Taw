<!DOCTYPE html>
<html lang="my">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AMT Native Pro</title>
    <script src="https://unpkg.com/@capacitor/core@latest/dist/capacitor.js"></script>
    <script src="https://unpkg.com/@capacitor/camera@latest/dist/capacitor-camera.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <style>
        body { font-family: sans-serif; background: #f4f4f4; margin: 0; padding: 20px; }
        .card { background: white; padding: 20px; border-radius: 15px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        .btn-main { background: #ee4d2d; color: white; border: none; width: 100%; padding: 15px; border-radius: 10px; font-weight: bold; margin-top: 10px; font-size: 16px; }
        .btn-video { background: #00bfa5; margin-top: 10px; }
        #preview { display: flex; gap: 10px; margin-top: 15px; overflow-x: auto; }
        .pre-img { width: 80px; height: 80px; border-radius: 8px; object-fit: cover; border: 2px solid #ee4d2d; }
        input { width: 100%; padding: 12px; margin: 10px 0; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; }
        #status { color: #ee4d2d; font-size: 12px; text-align: center; margin-top: 5px; }
    </style>
</head>
<body>

<div class="card">
    <h3 style="text-align:center; color:#ee4d2d;">AMT Native Seller</h3>
    
    <button class="btn-main" onclick="pickImage()">ğŸ“¸ á€“á€¬á€á€ºá€•á€¯á€¶á€›á€½á€±á€¸á€›á€”á€º (Native)</button>
    
    <input type="file" id="videoIn" accept="video/*" style="display:none" onchange="uploadVideo(event)">
    <button class="btn-main btn-video" onclick="document.getElementById('videoIn').click()">ğŸ¥ á€—á€®á€’á€®á€šá€­á€¯á€á€„á€ºá€›á€”á€º</button>

    <div id="preview"></div>
    <div id="status"></div>

    <input type="text" id="pName" placeholder="á€•á€…á€¹á€…á€Šá€ºá€¸á€¡á€™á€Šá€º">
    <input type="number" id="pPrice" placeholder="á€ˆá€±á€¸á€”á€¾á€¯á€”á€ºá€¸ (à¸¿)">
    <button class="btn-main" id="pubBtn" onclick="publish()">ğŸš€ á€¡á€á€¯á€á€„á€ºá€™á€Šá€º</button>
</div>

<script>
    const { Camera } = capacitorExports.Camera;
    const firebaseConfig = { apiKey: "AIzaSyD1KAKqhFVi8VTJRtoolzQKrEmXTnmZUsc", authDomain: "ah-mar-thaw.firebaseapp.com", projectId: "ah-mar-thaw", storageBucket: "ah-mar-thaw.firebasestorage.app", messagingSenderId: "976312084818", appId: "1:976312084818:web:2d0f7b922e17142768328b" };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    let compressedImages = [];
    let videoUrl = "";

    // áá‹ Native Camera & Auto Compression (50KB-100KB)
    async function pickImage() {
        try {
            const image = await Camera.getPhoto({
                quality: 50, // á€¡á€›á€Šá€ºá€¡á€á€½á€±á€¸á€€á€­á€¯ á€œá€»á€¾á€±á€¬á€·á€á€»á€•á€¼á€®á€¸ á€†á€­á€¯á€’á€ºá€á€»á€¯á€¶á€·á€á€¼á€„á€ºá€¸
                resultType: "base64",
                source: "PROMPT",
                width: 600 // á€•á€¯á€¶á€¡á€€á€»á€šá€ºá€€á€­á€¯ á€€á€”á€·á€ºá€á€á€ºá€á€¼á€„á€ºá€¸á€–á€¼á€„á€·á€º File size á€€á€­á€¯ á€‘á€•á€ºá€á€»á€¯á€¶á€·á€á€¼á€„á€ºá€¸
            });

            const base64Data = "data:image/jpeg;base64," + image.base64String;
            compressedImages.push(base64Data);
            
            const imgTag = '<img src="'+base64Data+'" class="pre-img">';
            document.getElementById('preview').innerHTML += imgTag;
            document.getElementById('status').innerText = "á€•á€¯á€¶ " + compressedImages.length + " á€•á€¯á€¶ á€›á€½á€±á€¸á€•á€¼á€®á€¸á€•á€«á€•á€¼á€®";
        } catch (e) { console.log("User cancelled"); }
    }

    // á‚á‹ Video Handling (Cloudinary á€¡á€á€™á€²á€· Cloud á€á€­á€¯á€· á€á€„á€ºá€á€¼á€„á€ºá€¸)
    async function uploadVideo(e) {
        const file = e.target.files[0];
        if(!file) return;
        document.getElementById('status').innerText = "á€—á€®á€’á€®á€šá€­á€¯á€á€„á€ºá€”á€±á€•á€«á€á€Šá€º... á€á€á€…á€±á€¬á€„á€·á€ºá€•á€«";
        
        const formData = new FormData();
        formData.append('file', file);
        formData.append('upload_preset', 'ml_default'); // Cloudinary Settings á€™á€¾á€¬ á€’á€«á€€á€­á€¯á€–á€½á€„á€·á€ºá€‘á€¬á€¸á€›á€•á€«á€™á€šá€º

        try {
            const res = await fetch('https://api.cloudinary.com/v1_1/demo/video/upload', { method: 'POST', body: formData });
            const data = await res.json();
            videoUrl = data.secure_url;
            document.getElementById('status').innerText = "á€—á€®á€’á€®á€šá€­á€¯ á€á€„á€ºá€•á€¼á€®á€¸á€•á€«á€•á€¼á€® âœ…";
        } catch (err) {
            alert("Video upload error. Storage á€•á€¼á€Šá€·á€ºá€”á€±á€•á€¯á€¶á€›á€á€Šá€ºá‹");
        }
    }

    async function publish() {
        const name = document.getElementById('pName').value;
        const price = document.getElementById('pPrice').value;
        if(!name || compressedImages.length === 0) return alert("á€¡á€á€»á€€á€ºá€¡á€œá€€á€ºá€…á€¯á€¶á€¡á€±á€¬á€„á€ºá€–á€¼á€Šá€·á€ºá€•á€«");

        const btn = document.getElementById('pubBtn');
        btn.disabled = true;
        btn.innerText = "á€á€„á€ºá€”á€±á€á€Šá€º...";

        try {
            await db.collection("products").add({
                name: name,
                price: Number(price),
                images: compressedImages,
                video: videoUrl,
                time: Date.now()
            });
            alert("á€•á€…á€¹á€…á€Šá€ºá€¸á€á€„á€ºá€á€¼á€„á€ºá€¸ á€¡á€±á€¬á€„á€ºá€™á€¼á€„á€ºá€•á€«á€á€Šá€ºá‹");
            location.reload();
        } catch (e) {
            alert("Error: " + e.message);
            btn.disabled = false;
        }
    }
</script>
</body>
</html>
