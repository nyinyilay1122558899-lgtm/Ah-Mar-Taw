<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tracking & Rating</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <style>
        body { font-family: sans-serif; background: #f4f7f6; padding: 20px; }
        .box { max-width: 400px; margin: auto; background: white; padding: 20px; border-radius: 15px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        #map { height: 250px; border-radius: 10px; margin: 15px 0; border: 2px solid #2e7d32; }
        .status-badge { background: #e8f5e9; color: #2e7d32; padding: 10px; border-radius: 5px; text-align: center; font-weight: bold; }
        /* Rating Style */
        #rating-area { display: none; text-align: center; background: #fffde7; padding: 20px; border-radius: 10px; margin-top: 20px; border: 1px dashed #fbc02d; }
        .star { font-size: 30px; cursor: pointer; color: #ccc; }
        .star.selected { color: #fbc02d; }
        button { background: #2e7d32; color: white; border: none; padding: 10px 20px; border-radius: 5px; margin-top: 10px; cursor: pointer; }
    </style>
</head>
<body>
    <div class="box">
        <div class="status-badge" id="status-display">á€…á€…á€ºá€†á€±á€¸á€”á€±á€†á€²...</div>
        <div id="map"></div>
        <p id="eta-text" style="text-align:center;">â³ á€á€”á€·á€ºá€™á€¾á€”á€ºá€¸á€á€»á€­á€”á€º: á€á€½á€€á€ºá€á€»á€€á€ºá€”á€±á€†á€²...</p>

        <div id="rating-area">
            <h3>ğŸŒŸ á€•á€…á€¹á€…á€Šá€ºá€¸á€›á€›á€¾á€­á€•á€¼á€®á€œá€¬á€¸á€á€„á€ºá€—á€»á€¬?</h3>
            <p>Rider á€€á€­á€¯ á€¡á€™á€¾á€á€ºá€•á€±á€¸á€á€²á€·á€•á€«á€¦á€¸</p>
            <span class="star" onclick="setRate(1)">â˜…</span>
            <span class="star" onclick="setRate(2)">â˜…</span>
            <span class="star" onclick="setRate(3)">â˜…</span>
            <span class="star" onclick="setRate(4)">â˜…</span>
            <span class="star" onclick="setRate(5)">â˜…</span>
            <br>
            <button onclick="submitRating()">Confirm & Submit</button>
        </div>
    </div>

    <script>
        const config = { apiKey: "AIzaSyD1KAKqhFVi8VTJRtoolzQKrEmXTnmZUsc", authDomain: "ah-mar-thaw.firebaseapp.com", projectId: "ah-mar-thaw", storageBucket: "ah-mar-thaw.appspot.com", messagingSenderId: "33857508316", appId: "1:33857508316:web:865529f7f9859f7c07b469" };
        firebase.initializeApp(config);
        const db = firebase.firestore();
        const urlParams = new URLSearchParams(window.location.search);
        const orderId = urlParams.get('id');

        const map = L.map('map').setView([16.8409, 96.1735], 13);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
        let riderMarker = L.marker([16.8409, 96.1735]).addTo(map);

        let selectedStars = 0;

        if(orderId) {
            db.collection("orders").doc(orderId).onSnapshot(doc => {
                const data = doc.data();
                document.getElementById('status-display').innerText = data.status;

                // Status á€•á€¼á€®á€¸á€á€½á€¬á€¸á€›á€„á€º Rating á€•á€¼á€™á€šá€º
                if(data.status === "á€•á€­á€¯á€·á€†á€±á€¬á€„á€ºá€™á€¾á€¯ á€•á€¼á€®á€¸á€™á€¼á€±á€¬á€€á€ºá€•á€«á€•á€¼á€®") {
                    document.getElementById('rating-area').style.display = "block";
                    document.getElementById('map').style.display = "none";
                    document.getElementById('eta-text').style.display = "none";
                }

                if(data.rider_lat) {
                    const pos = [data.rider_lat, data.rider_lng];
                    riderMarker.setLatLng(pos);
                    map.panTo(pos);
                }
            });
        }

        function setRate(num) {
            selectedStars = num;
            const stars = document.querySelectorAll('.star');
            stars.forEach((s, idx) => {
                s.classList.toggle('selected', idx < num);
            });
        }

        function submitRating() {
            if(selectedStars === 0) return alert("á€€á€¼á€šá€ºá€•á€½á€„á€·á€ºá€œá€±á€¸ á€›á€½á€±á€¸á€•á€±á€¸á€•á€«á€¦á€¸");
            db.collection("orders").doc(orderId).update({
                rating: selectedStars,
                ratingConfirmed: true
            }).then(() => {
                alert("á€€á€»á€±á€¸á€‡á€°á€¸á€á€„á€ºá€•á€«á€á€šá€ºá€á€„á€ºá€—á€»á€¬!");
                window.location.href = "index.html"; // á€›á€¾á€±á€·á€†á€¯á€¶á€¸á€•á€¼á€”á€ºá€á€½á€¬á€¸á€™á€šá€º
            });
        }
    </script>
</body>
</html>



